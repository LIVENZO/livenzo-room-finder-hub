<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Livenzo Payment</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 32px 24px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      text-align: center;
    }
    .logo { font-size: 24px; font-weight: 700; color: #3B82F6; margin-bottom: 8px; }
    .subtitle { color: #64748b; font-size: 14px; margin-bottom: 24px; }
    .amount { font-size: 36px; font-weight: 700; color: #1e293b; margin: 16px 0; }
    .amount-label { color: #94a3b8; font-size: 13px; }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #e2e8f0;
      border-top: 4px solid #3B82F6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status { font-size: 15px; color: #475569; margin-top: 12px; }
    .success-icon { font-size: 48px; margin-bottom: 12px; }
    .error-icon { font-size: 48px; margin-bottom: 12px; }
    .btn {
      display: inline-block;
      padding: 14px 28px;
      background: #3B82F6;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      text-decoration: none;
      width: 100%;
    }
    .btn:hover { background: #2563eb; }
    .btn-outline {
      background: white;
      color: #3B82F6;
      border: 2px solid #3B82F6;
    }
    .btn-outline:hover { background: #eff6ff; }
    .secure-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: #64748b;
      font-size: 12px;
      margin-top: 16px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div class="container" id="loading-state">
    <div class="logo">Livenzo</div>
    <div class="subtitle">Secure Payment</div>
    <div class="spinner"></div>
    <div class="status">Opening payment gateway...</div>
  </div>

  <!-- Success State -->
  <div class="container hidden" id="success-state">
    <div class="success-icon">‚úÖ</div>
    <div class="logo">Payment Successful!</div>
    <div class="subtitle">Your payment has been verified and processed.</div>
    <p class="status" id="success-message"></p>
    <button class="btn" onclick="returnToApp()">Return to App</button>
    <div class="secure-badge">üîí Verified by Razorpay</div>
  </div>

  <!-- Failure State -->
  <div class="container hidden" id="failure-state">
    <div class="error-icon">‚ùå</div>
    <div class="logo" style="color: #ef4444;">Payment Failed</div>
    <div class="subtitle" id="failure-message">Payment was not completed.</div>
    <button class="btn" onclick="retryPayment()">Try Again</button>
    <button class="btn btn-outline" onclick="returnToApp()" style="margin-top: 10px;">Return to App</button>
  </div>

  <!-- Cancelled State -->
  <div class="container hidden" id="cancelled-state">
    <div class="error-icon">üîô</div>
    <div class="logo" style="color: #f59e0b;">Payment Cancelled</div>
    <div class="subtitle">You cancelled the payment. You can try again anytime.</div>
    <button class="btn" onclick="retryPayment()">Try Again</button>
    <button class="btn btn-outline" onclick="returnToApp()" style="margin-top: 10px;">Return to App</button>
  </div>

  <script>
    // Read params from URL
    const params = new URLSearchParams(window.location.search);
    const razorpayKey = params.get('key');
    const orderId = params.get('order_id');
    const amount = params.get('amount');
    const currency = params.get('currency') || 'INR';
    const bookingId = params.get('booking_id');
    const roomId = params.get('room_id');
    const paymentType = params.get('type') || 'token'; // 'token' or 'rent'
    const paymentId = params.get('payment_id'); // for rent payments
    const userName = params.get('name') || '';
    const userEmail = params.get('email') || '';
    const userPhone = params.get('phone') || '';
    const description = params.get('description') || 'Livenzo Payment';
    const supabaseUrl = params.get('supabase_url');
    const returnUrl = params.get('return_url') || '';

    function showState(stateId) {
      document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
      document.getElementById(stateId).classList.remove('hidden');
    }

    function returnToApp() {
      // Try deep link first (Android intent)
      const intentUrl = 'intent://payment-complete#Intent;scheme=livenzo;package=com.livenzo.app;end';
      
      // Try multiple approaches to return to the app
      if (returnUrl) {
        window.location.href = returnUrl;
      } else {
        // Try to close the browser tab
        window.close();
        // Fallback: redirect to app URL
        setTimeout(() => {
          window.location.href = intentUrl;
        }, 500);
        setTimeout(() => {
          // Final fallback - just show a message
          document.getElementById('success-state').querySelector('.subtitle').textContent = 
            'Please switch back to the Livenzo app manually.';
        }, 1500);
      }
    }

    async function verifyPayment(paymentResponse) {
      try {
        if (!supabaseUrl) throw new Error('Missing Supabase URL');

        const verifyUrl = `${supabaseUrl}/functions/v1/razorpay-redirect-verify`;
        const res = await fetch(verifyUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: paymentType,
            bookingRequestId: bookingId,
            roomId: roomId,
            paymentId: paymentId,
            razorpayPaymentId: paymentResponse.razorpay_payment_id,
            razorpayOrderId: paymentResponse.razorpay_order_id,
            razorpaySignature: paymentResponse.razorpay_signature,
          })
        });

        const data = await res.json();
        if (data.success) {
          document.getElementById('success-message').textContent = 
            paymentType === 'token' 
              ? 'Your room has been locked successfully!' 
              : 'Your rent payment has been recorded.';
          showState('success-state');
        } else {
          document.getElementById('failure-message').textContent = data.error || 'Verification failed. Please contact support.';
          showState('failure-state');
        }
      } catch (err) {
        console.error('Verification error:', err);
        // Payment went through but verification failed - show partial success
        document.getElementById('success-message').textContent = 
          'Payment received. Verification is processing. Please check the app.';
        showState('success-state');
      }
    }

    function openRazorpay() {
      if (!razorpayKey || !orderId || !amount) {
        document.getElementById('failure-message').textContent = 'Invalid payment parameters. Please try again from the app.';
        showState('failure-state');
        return;
      }

      const options = {
        key: razorpayKey,
        amount: parseInt(amount),
        currency: currency,
        name: 'Livenzo',
        description: description,
        order_id: orderId,
        prefill: {
          name: userName,
          email: userEmail,
          contact: userPhone,
        },
        handler: function(response) {
          showState('loading-state');
          document.querySelector('#loading-state .status').textContent = 'Verifying payment...';
          verifyPayment(response);
        },
        modal: {
          ondismiss: function() {
            showState('cancelled-state');
          }
        },
        theme: { color: '#3B82F6' }
      };

      try {
        const rzp = new Razorpay(options);
        rzp.on('payment.failed', function(response) {
          document.getElementById('failure-message').textContent = 
            response.error?.description || 'Payment failed. Please try again.';
          showState('failure-state');
        });
        rzp.open();
      } catch (err) {
        console.error('Razorpay error:', err);
        document.getElementById('failure-message').textContent = 'Failed to open payment gateway.';
        showState('failure-state');
      }
    }

    function retryPayment() {
      showState('loading-state');
      document.querySelector('#loading-state .status').textContent = 'Opening payment gateway...';
      setTimeout(openRazorpay, 500);
    }

    // Auto-open Razorpay when page loads
    window.addEventListener('load', function() {
      setTimeout(openRazorpay, 800);
    });
  </script>
</body>
</html>
